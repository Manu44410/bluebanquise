#jinja2: lstrip_blocks: "True"
#### Blue Banquise file ####
## {{ ansible_managed }}

include "/etc/powerman/ipmipower.dev"

{% if icebergs_system == true %}
# Iceberg system is on
  {% set range = groups[j2_current_iceberg] %}
  {% for host in groups[managements_group_name] %}
    {% if hostvars[host]['iceberg_master'] == j2_current_iceberg %}
      {% set _ = range.append(host) %}
    {% endif %}
  {% endfor %}
{% else %}
  {% set range = groups['all'] %}
{% endif %}

{% for equipment in j2_equipment_groups_list %}
  {% set hosts = [] %}
  {% set bmcs = [] %}
  {% for host in groups[equipment] %}
    {% if host in range and hostvars[host]['bmc']['name'] is defined %}
      {{ hosts.append(host) }}
      {{ bmcs.append(hostvars[host]['bmc']['name']) }}
    {% endif %}
  {% endfor %}
  {% if hosts | length > 0 %}
    {# Gather BMC network settings for first host of this ep. Assumed reference for others. #}
    {% if hostvars[hosts[0]]['bmc']['ip4'] is defined %}{# BMC is defined inside host #}
      {% set credentials_host = hosts[0] %}{# Define host as credentials source #}
    {% else %}{# BMC is defined outside host #}
      {% set credentials_host = hostvars[hosts[0]]['bmc']['name'] %}{# Define external bmc as credentials source #}
    {% endif %}
    {# Gather BMC credentials settings #}
    {% if hostvars[credentials_host]['ep_host_authentication'] is defined %}{# Check if host_authentication is defined #}
      {% set host_bmc_user = (hostvars[credentials_host]['ep_host_authentication'] | selectattr('protocol','match','IPMI') | map(attribute='user') | list | first) %}
      {% set host_bmc_password = (hostvars[credentials_host]['ep_host_authentication'] | selectattr('protocol','match','IPMI') | map(attribute='password') | list | first) %}
    {% else %}{# Fall back to equipment_authentication | DATAMODEL 2.0 DEPRECATION #}
      {% set host_bmc_user = hostvars[credentials_host]['ep_equipment_authentication']['user'] %}
      {% set host_bmc_password = hostvars[credentials_host]['ep_equipment_authentication']['password'] %}
    {% endif %}
device "{{ equipment }}" "ipmipower" "/usr/sbin/ipmipower --wait-until-on --wait-until-off -h {{ bmcs|nodeset }} -u {{ host_bmc_user }} -p {{ host_bmc_password }} |&"
node "{{ hosts|nodeset }}" "{{ equipment }}" "{{ bmcs|nodeset }}"
  {% endif %}
{% endfor %}
